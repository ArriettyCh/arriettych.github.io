# **å‡ ä¸ªå› å­çš„å¤ç°ä¸æµ‹è¯•**

!!! warning "**å…³äºæˆ‘çš„ä»£ç **"
    æƒ­æ„§ï¼Œæˆ‘è¿™é¡¹ä½œä¸šæ˜¯åŸºäºä¸€ä½å­¦é•¿çš„ä»£ç ä¿®æ”¹çš„ï¼Œè€Œä¸”ä¼¼ä¹è¿˜æŠŠä»–åŸæ¥æ­£ç¡®çš„ä»£ç æ”¹é”™äº†ğŸ¤£ï¼Œä½†æ˜¯å› ä¸ºæ—¶é—´æ¯”è¾ƒç´§ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æ¥å¾—åŠæ£€æŸ¥ã€‚æˆ‘å»ºè®®å¤§å®¶è¿˜æ˜¯ä»é›¶å¼€å§‹æ„å»ºè‡ªå·±çš„æ¡†æ¶ï¼Œä¸è¦è¯•å›¾å°†æˆ‘çš„ä»£ç æ”¹å¯¹ï¼ˆå¦‚æœä½ å‘ç°äº†æˆ‘çš„é”™è¯¯ï¼Œè¯·è”ç³»æˆ‘ï¼Œéå¸¸æ„Ÿè°¢ğŸ™‡â€â™€ï¸ï¼‰ã€‚æˆ‘çš„ä»£ç ä»…ä¾›å‚è€ƒï¼Œä¸ä¿è¯ç»“æœçš„æ­£ç¡®æ€§ã€‚

## **åœ¨å¼€å§‹å‰ï¼šå…³äºä½œä¸šçš„å‡ ç‚¹å»ºè®®**

1. å¦‚æœä½ è¿½æ±‚æ•ˆç‡ï¼Œå°½å¯èƒ½ä¸è¦ä½¿ç”¨`.ipynb`æ–‡ä»¶ç¼–å†™ä»£ç ã€‚å®ƒè™½ç„¶å¯ä»¥å†™ä¸€æ­¥çœ‹ä¸€æ­¥ï¼Œåœ¨ç¼ºä¹å®Œæ•´æ€è·¯æ—¶æä¾›æ›´åŠ ç›´è§‚çš„å‚è€ƒï¼›ä½†ä¸€æ—¦æ–‡ä»¶å¤§åˆ°ä¸€å®šç¨‹åº¦ï¼Œè¿è¡Œæµç•…åº¦å°†æ˜¯ç¾éš¾æ€§çš„ï¼Œå°¤å…¶æ˜¯å½“ä½ è¯•å›¾å¯è§†åŒ–æŸä¸ªåºå¤§çš„`DataFrame`æ—¶ï¼›
2. å½“ç„¶ï¼Œå¦‚æœä½ å¯¹ä»£ç æ²¡æœ‰å®Œæ•´çš„æ€è·¯ï¼Œ`.ipynb`ç¡®å®æ˜¯ä¸€ç§æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒå¯ä»¥è®©ä½ åŠæ—¶æŸ¥çœ‹å½“å‰çš„è¿è¡Œç»“æœï¼›
3. å»ºè®®åœ¨æ­å»ºæ¡†æ¶æ—¶é¿å…`DataFrame`çš„ç¢ç‰‡åŒ–æ“ä½œï¼Œå°½å¯èƒ½ä¸è¦å¯¹`DataFrame`é¢‘ç¹æ“ä½œï¼Œè¿™ä¼šå¯¼è‡´ä½ çš„ç¨‹åºæ€§èƒ½å¤§å¹…é™ä½ã€‚ç­‰æ¡†æ¶å†™å¥½äº†å†è¿›è¡Œè°ƒæ•´å¾ˆå¯èƒ½ä¼šå¼•å‘æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼›
4. ä¸Šæ‰‹`joblib`çš„ä½¿ç”¨ã€‚`joblib`æ˜¯ä¸€ä¸ªç”¨äºå¹¶è¡Œè®¡ç®—çš„åº“ï¼Œå› ä¸ºå› å­çš„è®¡ç®—æ˜¯äº’ä¸ä¾èµ–çš„ï¼Œå…·æœ‰å¹¶è¡Œè®¡ç®—çš„å…ˆå¤©ä¼˜åŠ¿ï¼Œä¸€ä¸ªç®€å•çš„`Parallel`å°±å¯ä»¥å®ç°å¤§å¹…åŠ é€Ÿã€‚ä»¥è®¡ç®—é€Ÿåº¦æœ€æ…¢çš„`std_FF3factor_1m`å› å­ä¸ºä¾‹ï¼Œåœ¨å¹¶è¡Œä¼˜åŒ–å‰ï¼Œæˆ‘çš„å‡½æ•°éœ€è¦è¿è¡Œçº¦30åˆ†é’Ÿï¼›è€Œç»è¿‡ä¼˜åŒ–åï¼Œå®ƒå¯ä»¥åœ¨2åˆ†é’Ÿå†…ç»™å‡ºç»“æœ

## **ä½œä¸šæè¿°**
### **åŸºæœ¬æµç¨‹**
1. **è‚¡ç¥¨æ± ç­›é€‰**ï¼šå‰”é™¤ä¸Šå¸‚ä¸æ»¡252ä¸ªäº¤æ˜“æ—¥çš„è‚¡ç¥¨ï¼ˆ`data/IPO_date.csv`ï¼‰ï¼›å‰”é™¤å·²é€€å¸‚è‚¡ç¥¨ï¼ˆ`data/delist_date.csv`ï¼‰ï¼›å‰”é™¤å½“æœˆæœ«æˆªé¢æ—¥åœç‰Œè‚¡ç¥¨
2. **åŸå§‹å› å­å€¼**ï¼šè®¡ç®—2010å¹´12æœˆ31æ—¥ï½2024å¹´11æœˆ30æ—¥çš„å› å­å€¼ï¼Œå¦‚æœåœ¨ç¬¬ä¸€æ­¥ä¸­è‚¡ç¥¨è¢«ç­›é€‰å‡ºè‚¡ç¥¨æ± ï¼Œå› å­å€¼è®¾ç½®ä¸º`NaN`
3. **å› å­é¢„å¤„ç†**
    - **å»é™¤æå€¼**ï¼šå°†å› å­å€¼å¤§äº`mean + 3 * std`çš„å› å­ç½®ä¸º`mean + 3 * std`ï¼Œå°†å› å­å€¼å°äº`mean - 3 * std`çš„å› å­ç½®ä¸º`mean - 3 * std`
    - **è¡Œä¸šå¸‚å€¼ä¸­æ€§åŒ–**ï¼šå› å­ä¸ºå› å˜é‡ï¼Œä»¥Aè‚¡å¸‚å€¼å› å­ï¼ˆæµé€šå¸‚å€¼å–å¯¹æ•°ã€å»æå€¼ã€zscoreæ ‡å‡†åŒ–ï¼‰ã€ä¸­ä¿¡ä¸€çº§è¡Œä¸šå“‘å˜é‡ï¼ˆ1ï½29è½¬æ¢ä¸º29ä¸ªçš„0/1å˜é‡ï¼›è¡Œä¸š30å¿½ç•¥ï¼‰ä¸ºè‡ªå˜é‡ï¼ŒOLSï¼Œå–æ®‹å·®
    - **æ ‡å‡†åŒ–**ï¼šzscoreæ ‡å‡†åŒ–ï¼Œè½¬æ¢ä¸ºå‡å€¼ä¸º0ã€æ ‡å‡†å·®ä¸º1çš„åˆ†å¸ƒ
4. **å› å­æ£€éªŒ**
    - **RankICæ³•**ï¼šè®¡ç®—å› å­å€¼å’Œä¸‹ä¸ªè‡ªç„¶æœˆæ”¶ç›Šç‡çš„Spearmanç›¸å…³ç³»æ•°
    - **åˆ†å±‚æµ‹è¯•æ³•**ï¼šå¯¹énanå› å­å€¼è¿›è¡Œé™åºæ’åˆ—ï¼Œå‰20%è‚¡ç¥¨è§†ä½œç¬¬1å±‚ï¼Œ20%-40%è‚¡ç¥¨è§†ä½œç¬¬2å±‚â€¦â€¦ï¼Œä¸‹ä¸ªè‡ªç„¶æœˆæŒæœ‰è¯¥å±‚è‚¡ç¥¨ï¼Œç­‰æƒè®¡ç®—æ”¶ç›Šç‡

### **å› å­ä»‹ç»**
1. **`return_1m`**ï¼šè¿‘21ä¸ªäº¤æ˜“æ—¥åŒºé—´æ”¶ç›Šç‡ï¼›
2. **`turn_1m`**ï¼šè¿‘21ä¸ªäº¤æ˜“æ—¥æ¯æ—¥æ¢æ‰‹ç‡çš„å‡å€¼ï¼›
3. **`std_1m`**ï¼šè¿‘21ä¸ªäº¤æ˜“æ—¥æ¯æ—¥æ”¶ç›Šç‡çš„æ ‡å‡†å·®ï¼›
4. **`std_FF3factor_1m`**ï¼šè¿‘21ä¸ªäº¤æ˜“æ—¥å†…ï¼Œæ—¥æ”¶ç›Šç‡åºåˆ—å¯¹ä¸­è¯å…¨æŒ‡æ—¥æ”¶ç›Šç‡ã€SMBå› å­æ—¥æ”¶ç›Šç‡ã€HMLå› å­æ—¥æ”¶ç›Šç‡åºåˆ—è¿›è¡Œå¤šå…ƒçº¿æ€§å›å½’çš„æ®‹å·®çš„æ ‡å‡†å·®ã€‚
    - **SMBå› å­æ—¥æ”¶ç›Šç‡**ï¼šåœ¨æ¯ä¸ªäº¤æ˜“æ—¥ï¼Œå¯¹è‚¡ç¥¨æŒ‰æ€»å¸‚å€¼æ’åºï¼Œå30%çš„è‚¡ç¥¨ç®—æœ¯å¹³å‡æ”¶ç›Šç‡å‡å»å‰30%è‚¡ç¥¨ç®—æœ¯å¹³å‡æ”¶ç›Šç‡ï¼›
    - **HMLå› å­æ—¥æ”¶ç›Šç‡**ï¼šåœ¨æ¯ä¸ªäº¤æ˜“æ—¥ï¼Œå¯¹è‚¡ç¥¨æŒ‰å¸‚å‡€ç‡å€’åºæ’åºï¼Œå‰30%è‚¡ç¥¨ç®—æœ¯å¹³å‡æ”¶ç›Šç‡å‡å»å30%è‚¡ç¥¨ç®—æœ¯å¹³å‡æ”¶ç›Šç‡ã€‚

## **importå’Œåˆå§‹åŒ–**

> å› ä¸ºæˆ‘ç”¨äº†`pandas_market_calendars`ï¼Œæ‰€ä»¥å®é™…ä¸Šå¹¶æ²¡æœ‰ç”¨åˆ°`day`ï¼Œä½†æˆ‘è¿˜æ˜¯åˆå§‹åŒ–äº†ã€‚ä½†å»ºè®®è¿˜æ˜¯ä½¿ç”¨è€å¸ˆçš„æ•°æ®ï¼Œä¸¤è€…ä¼¼ä¹å­˜åœ¨å¾®å°çš„å·®å¼‚

```py
# import
import pandas as pd
from pandas_market_calendars import get_calendar
import numpy as np
from tqdm import tqdm  # è¿›åº¦æ¡ï¼Œå¯è§†åŒ–ç¨‹åºè¿è¡Œè¿›åº¦
from joblib import Parallel, delayed  # å¹¶è¡Œè®¡ç®—
import concurrent.futures  # å¹¶è¡Œè®¡ç®—
from pytz import timezone
import statsmodels.api as sm
from scipy.stats import zscore
from scipy.stats import spearmanr
import matplotlib.pyplot as plt

# è¯»å…¥æ•°æ®ï¼Œåˆå§‹åŒ–
calendar = get_calendar('XSHG')

stock_code = pd.read_csv('data/stock_code_info.csv')
stock_code = stock_code['stock_code']

day = pd.read_csv('data/day.csv')
day = day.loc[(day['date'] > '2010-11-30') & (day['date'] <= '2024-11-30')].reset_index(drop=True)
day = day['date']

month = pd.read_csv('data/month.csv')
month = month.loc[(month['date'] > '2010-11-30') & (month['date'] <= '2024-11-30')].reset_index(drop=True)
month = month['date']

amt_day = pd.read_csv('data/amt_day.csv')

IPO_date = pd.read_csv('data/IPO_date_info.csv')
IPO_date = IPO_date.rename(columns={'Unnamed: 0': 'stock_code'})

delist_date = pd.read_csv('data/delist_date_info.csv')
delist_date = delist_date.rename(columns={'Unnamed: 0': 'stock_code'})

close_adj_day = pd.read_csv('data/close_adj_day.csv')
close_adj_day = close_adj_day.rename(columns={'Unnamed: 0': 'stock_code'})

turn_day = pd.read_csv('data/turn_day.csv')
turn_day = turn_day.rename(columns={'Unnamed: 0': 'stock_code'})

close_adj_day_sf = close_adj_day.shift(1, axis=1)
close_adj_day_value = close_adj_day.iloc[:, 2:]
close_adj_day_sf_value = close_adj_day_sf.iloc[:, 2:]

csiall_day = pd.read_csv('data/csiall_day.csv')
close_day = pd.read_csv('data/close_day.csv')
share_totala_day = pd.read_csv('data/share_totala_day.csv')
pb_lf_day = pd.read_csv('data/pb_lf_day.csv')

cs_indus_code = pd.read_csv('data/cs_indus_code_day.csv')
float_a_shares_day = pd.read_csv('data/float_a_shares_day.csv')
```

## **è‚¡ç¥¨æ± ç­›é€‰**
1. **å‰”é™¤ä¸Šå¸‚ä¸æ»¡252ä¸ªäº¤æ˜“æ—¥çš„è‚¡ç¥¨**ï¼šéå†æ¯ä¸€åªè‚¡ç¥¨çš„IPOæ—¥æœŸï¼ŒåŠ ä¸Š252ä¸ªäº¤æ˜“æ—¥ï¼ˆç›´æ¥åŠ åœ¨ä¸‹æ ‡ä¸Šï¼Œç›¸æ¯”whileå¾ªç¯é€Ÿåº¦å¿«å¾—å¤šï¼‰ï¼Œå¦‚æœè¶…è¿‡å½“å‰æ—¥æœŸï¼Œå‰”é™¤è¯¥è‚¡ç¥¨ï¼›
2. **å‰”é™¤å·²é€€å¸‚è‚¡ç¥¨**ï¼šåœ¨`data/delist_date.csv`ä¸­è¯»å–é€€å¸‚æ—¥æœŸï¼Œå¦‚æœè¯¥æ—¥æœŸæœ‰æ•ˆï¼Œå‰”é™¤è¯¥è‚¡ç¥¨ï¼›
4. **å‰”é™¤å½“æœˆæœ«æˆªé¢æ—¥åœç‰Œè‚¡ç¥¨**ï¼šéå†æ¯ä¸€åªè‚¡ç¥¨çš„æœˆæœ«æˆªé¢æ—¥ï¼Œå¦‚æœåœç‰Œï¼Œå‰”é™¤è¯¥è‚¡ç¥¨ã€‚

```py
stock_chosen = []

for month_cut in month:  # éå†æ¯ä¸ªæœˆæœ«æˆªé¢æ—¥
    day_amt = amt_day[month_cut]  # è·å–æœˆæœ«æˆªé¢æ—¥çš„é”€å”®æ•°æ®

    day_amt = pd.DataFrame({'stock_code': stock_code, 'day_amt': day_amt, 'cut_day': month_cut, 'in_pool': 1})
    day_amt = pd.merge(day_amt, IPO_date, on='stock_code')  # åˆå¹¶IPOæ•°æ®
    day_amt = pd.merge(day_amt, delist_date, on='stock_code')  # åˆå¹¶é€€å¸‚æ•°æ®

    # ç­›é€‰è‚¡ç¥¨
    day_amt.loc[day_amt['cut_day'] < day_amt['to_date'], 'in_pool'] = 0  # å‰”é™¤ä¸Šå¸‚ä¸æ»¡252ä¸ªäº¤æ˜“æ—¥çš„è‚¡ç¥¨
    day_amt.loc[day_amt['day_amt'].isnull(), 'in_pool'] = 0  # å‰”é™¤æœˆæœ«æˆªé¢åœç‰Œè‚¡ç¥¨
    day_amt.loc[(day_amt['delist_date'].notnull()) & (day_amt['cut_day'] > day_amt['delist_date']), 'in_pool'] = 0  # å‰”é™¤é€€å¸‚è‚¡ç¥¨ï¼Œç©ºå€¼è¡¨ç¤ºè¿˜æ²¡é€€å¸‚

    day_amt = day_amt[day_amt['in_pool'] == 1]
    day_pool = day_amt['stock_code'].tolist()
    day_pool.insert(0, month_cut)
    stock_chosen.append(day_pool)

stock_chosen = pd.DataFrame(stock_chosen)
stock_chosen.columns = ['cut_day'] + [f'stock_{i}' for i in range(1, stock_chosen.shape[1])]
```

## **åŸå§‹å› å­è®¡ç®—**
### **å› å­1ï¼š`return_1m_raw`**
æŠŠæ¯ä¸ªæœˆæœ«æˆªé¢æ—¥çš„å¤æƒæ”¶ç›˜ä»·å’Œ21å¤©å‰çš„å¤æƒæ”¶ç›˜ä»·æ‹¿å‡ºæ¥ï¼Œè®¡ç®—æ”¶ç›Šç‡

```py
return_1m_raw = pd.DataFrame({'stock_code': stock_code})

for i in range(len(month)):
    stock = stock_chosen.iloc[i, 1:]  # å–å‡ºè¯¥æœˆæœ«æˆªé¢æ—¥çš„è‚¡ç¥¨æ± 
    stock = stock.dropna()
    stock = pd.DataFrame({'stock_code': stock})
    day = month[i]

    close_adj_today = pd.merge(stock, close_adj_day, on='stock_code', how='inner')  # å–å‡ºéœ€è¦çš„è‚¡ç¥¨æ”¶ç›˜ä»·æ•°æ®
    date_index = close_adj_today.columns.get_loc(day)  # æ‰¾åˆ°å½“æœˆæˆªé¢æ—¥çš„åˆ—ç´¢å¼•
    price_now = close_adj_today.iloc[:, date_index]
    price_21_before = close_adj_today.iloc[:, date_index - 21]  # å›æº¯21å¤©

    return_1m = (price_now - price_21_before) / price_21_before

    stock = stock.reset_index(drop=True)
    return_1m = return_1m.reset_index(drop=True)
    # é‡ç½®ç´¢å¼•ï¼Œä¿è¯stockå’Œreturn_1mç´¢å¼•ä¸€è‡´ï¼Œå¦åˆ™ä¼šå› ä¸ºç´¢å¼•ä¸ä¸€è‡´è€ŒæŠ¥é”™

    return_1m = pd.DataFrame({day: return_1m})
    return_1m = pd.concat([stock, return_1m], axis=1)
    return_1m_raw = pd.merge(return_1m_raw, return_1m, on='stock_code', how='outer')

return_1m_raw_T = return_1m_raw.T
return_1m_raw_T.columns = return_1m_raw_T.iloc[0]
return_1m_raw_T = return_1m_raw_T.iloc[1:]
return_1m_raw_T.to_csv('answer/factor_1_raw.csv')  # è½¬ç½®åå†å­˜å‚¨ï¼Œä»¥ç¬¦åˆæ ¼å¼è¦æ±‚
```

### **å› å­2ï¼š`turn_1m_raw`**
éå†æ¯ä¸ªæœˆæœ«æˆªé¢æ—¥ï¼Œå¹¶å‘å‰å–å‡ºè¿ç»­21å¤©çš„æ¢æ‰‹ç‡ï¼Œå–å‡å€¼ã€‚åªè¦å°†ä¸Šé¢çš„ä»£ç å¤åˆ¶ä¸‹æ¥ç„¶åå¾®æ”¹ä¸€ä¸‹å°±å¯ä»¥äº†

```py
turn_1m_raw = pd.DataFrame({'stock_code': stock_code})

for i in range(len(month)):
    stock = stock_chosen.iloc[i, 1:]  # å–å‡ºè¯¥æœˆæœ«æˆªé¢æ—¥çš„è‚¡ç¥¨æ± 
    stock = stock.dropna()
    stock = pd.DataFrame({'stock_code': stock})
    day = month[i]

    turn_today = pd.merge(stock, turn_day, on='stock_code', how='inner')  # å–å‡ºéœ€è¦çš„æ¢æ‰‹ç‡æ•°æ®
    date_index = turn_today.columns.get_loc(day)  # æ‰¾åˆ°å½“æœˆæˆªé¢æ—¥çš„åˆ—ç´¢å¼•
    turn_21 = turn_today.iloc[:, (date_index - 20):(date_index + 1)]  # å–å‡º21å¤©çš„æ¢æ‰‹ç‡

    turn_1m = turn_21.mean(axis=1)

    stock = stock.reset_index(drop=True)
    turn_1m = turn_1m.reset_index(drop=True)

    turn_1m = pd.DataFrame({day: turn_1m})
    turn_1m = pd.concat([stock, turn_1m], axis=1)
    turn_1m_raw = pd.merge(turn_1m_raw, turn_1m, on='stock_code', how='outer')

turn_1m_raw_T = turn_1m_raw.T
turn_1m_raw_T.columns = turn_1m_raw_T.iloc[0]
turn_1m_raw_T = turn_1m_raw_T.iloc[1:]
turn_1m_raw_T.to_csv('answer/factor_2_raw.csv')
```

### **å› å­3ï¼š`std_1m_raw`**
å’Œä¸Šé¢çš„ä¸¤ä¸ªå› å­æ€è·¯ä¸€è‡´ï¼Œå–å‡ºè¿‡å»22å¤©çš„è‚¡ä»·ï¼Œè®¡ç®—21å¤©çš„æ”¶ç›Šç‡ï¼Œç„¶åè®¡ç®—æ ‡å‡†å·®

```py
std_1m_raw = pd.DataFrame({'stock_code': stock_code})

for i in range(len(month)):
    stock = stock_chosen.iloc[i, 1:]  # å–å‡ºè¯¥æœˆæœ«æˆªé¢æ—¥çš„è‚¡ç¥¨æ± 
    stock = stock.dropna()
    stock = pd.DataFrame({'stock_code': stock})
    day = month[i]

    close_adj_today = pd.merge(stock, close_adj_day, on='stock_code', how='inner')  # å–å‡ºéœ€è¦çš„è‚¡ç¥¨æ”¶ç›˜ä»·æ•°æ®
    date_index = close_adj_today.columns.get_loc(day)  # æ‰¾åˆ°å½“æœˆæˆªé¢æ—¥çš„åˆ—ç´¢å¼•
    price_22 = close_adj_today.iloc[:, (date_index - 21):(date_index + 1)]  # è·å–è¿‡å»22å¤©çš„è‚¡ä»·æ•°æ®
    return_21 = price_22.pct_change(axis=1, fill_method=None).iloc[:, 1:]  # è®¡ç®—21å¤©çš„æ”¶ç›Šç‡

    std_1m = return_21.std(axis=1)  # è®¡ç®—æ”¶ç›Šç‡çš„æ ‡å‡†å·®

    stock = stock.reset_index(drop=True)
    std_1m = std_1m.reset_index(drop=True)

    std_1m = pd.DataFrame({day: std_1m})
    std_1m = pd.concat([stock, std_1m], axis=1)
    std_1m_raw = pd.merge(std_1m_raw, std_1m, on='stock_code', how='outer')

std_1m_raw_T = std_1m_raw.T
std_1m_raw_T.columns = std_1m_raw_T.iloc[0]
std_1m_raw_T = std_1m_raw_T.iloc[1:]
std_1m_raw_T.to_csv('answer/factor_3_raw.csv')
```

### **å› å­4ï¼š`std_FF3factor_1m_raw`**
1. **è®¡ç®—ä¸­è¯å…¨æŒ‡æ—¥æ”¶ç›Šç‡**ï¼šæŒ‰ç…§ä¸­è¯å…¨æŒ‡çš„å®šä¹‰è¿›è¡Œè®¡ç®—å³å¯ï¼Œæ˜¯ä¸ªGPTå°±ä¼šå†™

    ```py
    # è®¡ç®—æ”¶ç›Šç‡
    return_1 = (close_adj_day_value - close_adj_day_sf_value) / close_adj_day_sf_value
    return_1 = pd.concat([stock_code, return_1], axis=1)
    
    # è®¡ç®—å¸‚å€¼
    market_value = (share_totala_day.iloc[:, 1:] * close_day.iloc[:, 1:]).reset_index(drop=True)
    market_value = pd.concat([stock_code, market_value], axis=1)
    
    # æ’å
    market_rank = market_value.rank(axis=0, ascending=False)
    pb_rank = pb_lf_day.rank(axis=0, ascending=False)
    
    day_list = market_rank.columns[2:]
    
    # è®¡ç®—æ—¥å†è‚¡ä»·å¢é•¿ç‡ï¼ˆCSAï¼‰
    csiall_day_value = csiall_day.iloc[0, 2:].values  # ç›´æ¥å–å€¼ï¼Œé¿å…DataFrameä¸å¿…è¦çš„è½¬æ¢
    csiall_day_value_sf = csiall_day.shift(1, axis=1).iloc[0, 2:].values  # åŒæ ·å¤„ç†
    csa = (csiall_day_value - csiall_day_value_sf) / csiall_day_value_sf
    
    # åˆ›å»ºæœ€ç»ˆçš„DataFrame
    stock_csa_df = pd.DataFrame({'date': day_list, 'CSA': csa})
    ```

2. **è®¡ç®—SMB**ï¼šå…ˆè®¡ç®—å¸‚å€¼ï¼ˆæ”¶ç›˜ä»·ä¹˜ä»¥è‚¡æœ¬ï¼‰ï¼Œç„¶åæ ¹æ®å¸‚å€¼æ’åºï¼Œæ³¨æ„æ’åºæ—¶å¿½ç•¥`NaN`ã€‚æ­¤å¤–ï¼Œè¿™é‡Œ`stock_code`ä¸å†ä¿ç•™çœŸæ­£çš„è‚¡ç¥¨ä»£ç ï¼Œè€Œç”¨æ’åºå‰çš„ä¸‹æ ‡ä»£æ›¿ï¼Œæ–¹ä¾¿åé¢ç›´æ¥é€šè¿‡ä¸‹æ ‡å®šä½åˆ°è‚¡ç¥¨ï¼Œé¿å…ä¸å¿…è¦çš„æŸ¥æ‰¾
    ```py
    # æå‰è®¡ç®—æ‰€æœ‰è‚¡ç¥¨çš„æ”¶ç›Šç‡ï¼Œè¿™æ ·æ¯æ¬¡å°±ä¸éœ€è¦è¿›è¡Œmerge
    returns_dict = return_1.set_index('stock_code')[market_value.columns[2:]]  # æ¯åªè‚¡ç¥¨åœ¨æ¯ä¸€å¤©çš„æ”¶ç›Šç‡
    
    SMB = []
    for date in tqdm(market_value.columns[2:]):
        top_30_num = int(market_rank[date].count() * 0.3)
    
        # æ‰¾åˆ°å‰30%å’Œå30%çš„è‚¡ç¥¨ä¸‹æ ‡
        top_30_idx = market_rank[date].nsmallest(top_30_num).index
        bottom_30_idx = market_rank[date].nlargest(top_30_num).index
    
        # æå–æ”¶ç›Šç‡
        top_30_return = returns_dict.loc[stock_code[top_30_idx], date]
        bottom_30_return = returns_dict.loc[stock_code[bottom_30_idx], date]
    
        # è®¡ç®—SMB
        SMB_top = top_30_return.mean()
        SMB_bottom = bottom_30_return.mean()
        SMB.append(SMB_bottom - SMB_top)
    
    # å°†ç»“æœè½¬åŒ–ä¸ºDataFrame
    SMB_df = pd.DataFrame({'date': day_list, 'SMB': SMB})
    ```

3. **è®¡ç®—HML**ï¼šå…ˆè®¡ç®—å¸‚å‡€ç‡ï¼Œå› ä¸ºå¸‚å‡€ç‡ä¸ä¼šä¸ºè´Ÿï¼Œæ‰€ä»¥æŒ‰ç…§å¸‚å‡€ç‡çš„å€’æ•°æ’åºå’ŒæŒ‰å¸‚å‡€ç‡å€’åºæ’åºç­‰æ•ˆï¼Œä¸ºé¿å…ä¸å¿…è¦çš„è®¡ç®—ï¼Œé€‰æ‹©åè€…ï¼›SMBå¤åˆ¶ä¸‹æ¥å¾®æ”¹ä¸€ä¸‹å³å¯

    ```py
    # æå‰è®¡ç®—æ‰€æœ‰è‚¡ç¥¨çš„æ”¶ç›Šç‡ï¼Œé¿å…ç¢ç‰‡åŒ–æ“ä½œ
    returns_dict = return_1.set_index('stock_code')[market_value.columns[2:]]  # æ¯åªè‚¡ç¥¨åœ¨æ¯ä¸€å¤©çš„æ”¶ç›Šç‡

    HML = []
    for date in tqdm(market_value.columns[2:]):
        top_30_num = int(pb_rank[date].count() * 0.3)

        # æ‰¾åˆ°å‰30%å’Œå30%çš„è‚¡ç¥¨ä¸‹æ ‡
        top_30_idx = pb_rank[date].nlargest(top_30_num).index
        bottom_30_idx = pb_rank[date].nsmallest(top_30_num).index

        # æå–æ”¶ç›Šç‡
        top_30_return = returns_dict.loc[stock_code[top_30_idx], date]
        bottom_30_return = returns_dict.loc[stock_code[bottom_30_idx], date]

        # è®¡ç®—HML
        HML_top = top_30_return.mean()
        HML_bottom = bottom_30_return.mean()
        HML.append(HML_bottom - HML_top)

    # å°†ç»“æœè½¬åŒ–ä¸º DataFrame
    HML_df = pd.DataFrame({'date': market_value.columns[2:], 'HML': HML})
    ```

4. **OLSè®¡ç®—å› å­**ï¼šå»ºè®®é‡‡ç”¨å¹¶è¡Œè®¡ç®—ï¼Œå¦åˆ™è¿è¡Œé€Ÿåº¦è¿‡æ…¢ã€‚åŒæ—¶ï¼Œè¦å°½å¯èƒ½é¿å…åœ¨äºŒé‡å¾ªç¯ä¸­å¯¹`Dataframe`è¿›è¡Œè¿‡å¤šæ“ä½œï¼Œè¿™æ ·çš„ç¢ç‰‡åŒ–æ“ä½œä¼šå¯¼è‡´ç¨‹åºä¼šè¶Šè·‘è¶Šæ…¢

    ```py
    std_ff3_raw = pd.DataFrame(index=month, columns=stock_code)


    def process_month(i):
        day = month[i]
        stock = stock_chosen.iloc[i].dropna()
        stock = pd.DataFrame({'stock_code': stock})
        stock = stock[1:]

        # å³ç§»ä¸€å¤©è®¡ç®—æ”¶ç›Šç‡åºåˆ—
        close_adj_today = pd.merge(stock, close_adj_day, on='stock_code', how='inner')
        date_index = close_adj_today.columns.get_loc(day)
        day_range = close_adj_today.iloc[:, (date_index - 21):(date_index + 1)]
        day_range_sf = day_range.shift(1, axis=1)
        day_range = day_range.drop(day_range.columns[0], axis=1)
        day_range_sf = day_range_sf.drop(day_range_sf.columns[0], axis=1)

        return_day = (day_range - day_range_sf) / day_range_sf
        # print(return_day)

        result_dict = {}

        # è®¡ç®—å› å­
        for stock_index in return_day.index:
            returns = return_day.loc[stock_index]
            start_date = returns.index[-21]
            end_date = returns.index[-1]

            # è·å–å› å­æ•°æ®ï¼ˆæå‰è®¡ç®—ç´¢å¼•ï¼‰
            start_index = HML_df[HML_df['date'] == start_date].index[0]
            end_index = HML_df[HML_df['date'] == end_date].index[0]

            hml_data = HML_df.loc[start_index:end_index, 'HML'].reset_index(drop=True)
            smb_data = SMB_df.loc[start_index:end_index, 'SMB'].reset_index(drop=True)
            csa_data = stock_csa_df.loc[start_index:end_index, 'CSA'].reset_index(drop=True)

            # OLSå›å½’
            X = sm.add_constant(pd.concat([hml_data, smb_data, csa_data], axis=1))
            returns = returns.reset_index(drop=True)
            X['CSA'] = X['CSA'].astype(float)

            model = sm.OLS(returns, X)
            results = model.fit()

            # å–æ®‹å·®æ ‡å‡†å·®
            residuals = results.resid
            residual_std = residuals.std()

            result_dict[stock['stock_code'].iloc[stock_index]] = residual_std
            # print(stock['stock_code'].iloc[stock_index], residual_std)
            # print(stock)

        return result_dict


    # ä½¿ç”¨å¹¶è¡ŒåŒ–åŠ é€Ÿ
    results = Parallel(n_jobs=-1)(delayed(process_month)(i) for i in tqdm(range(len(month))))

    # results = Parallel(n_jobs=-1)(delayed(process_month)(i) for i in tqdm(range(1)))

    # å°†ç»“æœåˆå¹¶åˆ° std_ff3_raw ä¸­
    for i, result_dict in enumerate(results):
        for key, value in result_dict.items():
            std_ff3_raw.loc[month[i], key] = value

    # ä¿å­˜ç»“æœ
    std_ff3_raw.to_csv('answer/factor_4_raw.csv')
    ```

## **å› å­å¤„ç†**
### **åˆå§‹åŒ–**
è™½ç„¶ä¸Šé¢å·²ç»ç”Ÿæˆäº†å› å­å¤„ç†éœ€è¦ç”¨åˆ°çš„`DataFrame`ï¼ˆé‚£å››ä¸ª`factor_x_raw`ï¼‰ï¼Œä½†æˆ‘è¿˜æ˜¯é€‰æ‹©ä»å¯¼å‡ºçš„æ•°æ®ä¸­è¯»å…¥ï¼Œæ–¹ä¾¿æµ‹è¯•å’Œè°ƒæ•´ï¼Œä¹Ÿé¿å…äº†å¯¹ä¹‹å‰çš„ç»“æœè¿›è¡Œç ´åæ€§æ“ä½œã€‚åŒæ—¶ï¼Œé‡æ–°è¯»å…¥ä¸€éå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šé¿å…åŸ`DataFrame`ä¸­ä¸€äº›æœªå‘ç°çš„é—®é¢˜

```py
factor_1 = pd.read_csv('answer/factor_1_raw.csv')
factor_1 = factor_1.rename(columns={'Unnamed: 0': 'date'})

factor_2 = pd.read_csv('answer/factor_2_raw.csv')
factor_2 = factor_2.rename(columns={'Unnamed: 0': 'date'})

factor_3 = pd.read_csv('answer/factor_3_raw.csv')
factor_3 = factor_3.rename(columns={'Unnamed: 0': 'date'})

factor_4 = pd.read_csv('answer/factor_4_raw.csv')
factor_4 = factor_4.rename(columns={'Unnamed: 0': 'date'})
```

### **å»æå€¼**
è®¡ç®—å› å­æ ‡å‡†å·®ï¼Œç„¶åéå†æ‰€æœ‰å› å­å€¼ï¼Œå°†æ‰€æœ‰è¶…å‡ºèŒƒå›´çš„éƒ½è®¾å®šåœ¨è¾¹ç•Œä¸Š

```py
import pandas as pd
days = factor_1['date']

def process_std(factor):
    mean = factor.mean()
    std = factor.std()
    bottom = mean - 3 * std
    top = mean + 3 * std

    # æˆªæ–­è¶…å‡ºä¸Šä¸‹é™çš„æ•°æ®
    factor_value = factor.clip(lower=bottom, upper=top, axis=1)

    # æ‹¼æ¥æ—¥æœŸåˆ—å¹¶è®¾ç½®ç´¢å¼•
    processed_factor = pd.concat([days, factor_value], axis=1)
    processed_factor.set_index(processed_factor.columns[0], inplace=True)

    return processed_factor


# è°ƒç”¨å‡½æ•°
pro_factor_1_value = process_std(factor_1.iloc[:, 1:])
pro_factor_2_value = process_std(factor_2.iloc[:, 1:])
pro_factor_3_value = process_std(factor_3.iloc[:, 1:])
pro_factor_4_value = process_std(factor_4.iloc[:, 1:])
```

### **è¡Œä¸šå¸‚å€¼ä¸­æ€§åŒ–**
é¦–å…ˆè¦è®¡ç®—Aè‚¡å¸‚å€¼å› å­ï¼Œç„¶åä»¥å…¶å’Œä¸­ä¿¡ä¸€çº§è¡Œä¸šå“‘å˜é‡ä¸ºè‡ªå˜é‡ï¼ŒOLSå»æ®‹å·®ã€‚

1. **è®¡ç®—Aè‚¡å¸‚å€¼å› å­**ï¼šå–æµé€šå¸‚å€¼ï¼Œå–å¯¹æ•°ã€å»æå€¼ã€zscoreæ ‡å‡†åŒ–

    ```py
    # è¯»å–æ•°æ®
    float_a_shares_day = float_a_shares_day.iloc[:, 1:]
    close_day_value = close_day.iloc[:, 1:]

    # è®¡ç®—å¸‚å€¼
    float_market_value = float_a_shares_day * close_day_value

    # æ‹¼æ¥è‚¡ç¥¨ä»£ç ï¼Œå¹¶è½¬ç½®ï¼Œç®€åŒ–åˆ—åè®¾ç½®
    float_market_value_adj = pd.concat([stock_code, float_market_value], axis=1).T
    float_market_value_adj.columns = float_market_value_adj.iloc[0]
    float_market_value_adj = float_market_value_adj[1:]
    float_market_value_adj.index.name = 'date'
    float_market_value_adj.columns.name = None

    # è·å–åœ¨daysåˆ—è¡¨ä¸­çš„æ—¥æœŸ
    days = factor_1['date']
    float_market_value = float_market_value_adj[float_market_value_adj.index.isin(days)]

    # æ˜¾å¼è½¬æ¢ä¸º float ç±»å‹ï¼Œç„¶åå†æ›¿æ¢ 0 ä¸º NaN
    float_market_value = float_market_value.astype(float)  # å…ˆè½¬æ¢ä¸ºfloat
    float_market_value = float_market_value.replace(0, np.nan)  # ç„¶åè¿›è¡Œæ›¿æ¢

    # å–å¯¹æ•°
    float_market_value = np.log(float_market_value)

    # è®¡ç®—å¹³å‡å€¼å’Œæ ‡å‡†å·®
    mean = float_market_value.mean()
    std = float_market_value.std()

    # è®¾ç½®å»æå€¼çš„é˜ˆå€¼ä¸ºå¹³å‡å€¼Â±3å€æ ‡å‡†å·®
    threshold = 3 * std

    # å»æå€¼æ“ä½œ
    float_market_value = float_market_value.clip(lower=mean - threshold, upper=mean + threshold, axis=1)

    # zscoreæ ‡å‡†åŒ–
    float_market_value_zs = float_market_value.apply(lambda x: zscore(x, nan_policy='omit'), axis=1)
    ```

2. **è®¡ç®—ä¸­ä¿¡ä¸€çº§è¡Œä¸šå“‘å˜é‡**ï¼šä¸­ä¿¡ä¸€çº§è¡Œä¸šå“‘å˜é‡ï¼ˆå°†1-29è½¬æ¢ä¸º29ä¸ªçš„1/0å˜é‡ï¼›è¡Œä¸š30å¯å¿½ç•¥ï¼‰ä¸ºè‡ªå˜é‡

    ```py
    # 1. è°ƒæ•´æ ¼å¼
    cs_indus_code_01 = cs_indus_code.T
    cs_indus_code_01.columns = cs_indus_code_01.iloc[0]
    cs_indus_code_01 = cs_indus_code_01[1:]
    cs_indus_code_01.index.name = 'date'
    cs_indus_code_01.columns.name = None

    # 2. è¿‡æ»¤æ—¥æœŸ
    cs_indus_code_01 = cs_indus_code_01[cs_indus_code_01.index.isin(days)]

    # 3. ä½¿ç”¨applyæ›¿ä»£applymapï¼Œç›´æ¥è¿›è¡Œå€¼æ›¿æ¢
    converted_dfs = {i: cs_indus_code_01.apply(lambda col: np.where(col == i, 1, 0), axis=0) for i in range(1, 30)}
    ```

3. **è¡Œä¸šå¸‚å€¼ä¸­æ€§åŒ–**ï¼šä»¥Aè‚¡å¸‚å€¼å› å­å’Œä¸­ä¿¡ä¸€çº§è¡Œä¸šå“‘å˜é‡ä¸ºè‡ªå˜é‡ï¼ŒOLSå¤šå…ƒçº¿æ€§å›å½’ï¼Œå–æ®‹å·®ï¼ˆæˆ‘è¿™ä¸ªå‡½æ•°å†™å¾—æ¯”è¾ƒæ··ä¹±ï¼Œç¨å¾®æœ‰äº›ä½æ•ˆï¼Œä¸è¿‡å¹³å‡å¤„ç†ä¸€ä¸ªå› å­èŠ±15ç§’ä¹Ÿèƒ½æ¥å—ï¼‰

    ```py
    stock = stock_chosen.iloc[0]
    stock = stock.dropna()
    stock = stock[1:]

    def process_neu(pro_factor_value):
        factor_neu = pd.DataFrame({'stock_code': stock_code})

        for i in tqdm(range(len(month))):
            dep_var = pro_factor_value.iloc[i]  # å› å˜é‡
            dep_var = dep_var.dropna()
            dep_var = dep_var[dep_var.index.isin(stock)]
        
            indep_var = float_market_value_zs.iloc[i]  # è‡ªå˜é‡
            for tmp in range(1, 30):
                indep_var = pd.concat([indep_var, converted_dfs[tmp].iloc[i]], axis=1)
                indep_var = indep_var.dropna()

            # ç¡®ä¿åªæœ‰åŒæ—¶å‡ºç°åœ¨è‡ªå˜é‡å’Œå› å˜é‡é‡Œçš„è‚¡ç¥¨ä¼šè¢«åšå›å½’
            common_index = dep_var.index.intersection(indep_var.index)
            dep_var = dep_var[common_index]
            indep_var = indep_var.loc[common_index]

            # æ£€æŸ¥ç´¢å¼•æ˜¯å¦å¯¹é½
            indep_var = indep_var.reindex(dep_var.index) 

            # æ‹Ÿåˆæ¨¡å‹
            model = sm.OLS(dep_var, indep_var)
            results = model.fit()
            residuals = results.resid

            # é‡å‘½åæ®‹å·®
            residuals = residuals.rename(month[i])
            residuals = pd.DataFrame(residuals)
            residuals['stock_code'] = residuals.index
            residuals = residuals.rename(columns={residuals.columns[0]: month[i]})

            # åˆå¹¶ç»“æœ
            factor_neu = pd.merge(factor_neu, residuals, on='stock_code', how='outer')

        return factor_neu


    factor_1_neu = process_neu(pro_factor_1_value)
    factor_2_neu = process_neu(pro_factor_2_value)
    factor_3_neu = process_neu(pro_factor_3_value)
    factor_4_neu = process_neu(pro_factor_4_value)
    ```

### **æ ‡å‡†åŒ–**
zscoreæ ‡å‡†åŒ–ï¼šè½¬æ¢ä¸ºå‡å€¼ä¸º0ã€æ ‡å‡†å·®ä¸º1çš„åˆ†å¸ƒã€‚è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥å¥—ä¸€ä¸ª`zscore`å‡½æ•°å°±å®Œæˆäº†

```py
def process_std(factor_neu):
    factor_neu_T = factor_neu.T
    factor_neu_T.columns = factor_neu_T.iloc[0]
    factor_neu_T = factor_neu_T.iloc[1:]
    factor_neu_T = factor_neu_T.astype(float)

    factor_neu_T = factor_neu_T.apply(lambda x: zscore(x, nan_policy='omit'), axis=1)
    return factor_neu_T


factor_1_neu_std = process_std(factor_1_neu)
factor_1_neu_std.to_csv('answer/factor_1_processed.csv')
factor_2_neu_std = process_std(factor_2_neu)
factor_2_neu_std.to_csv('answer/factor_2_processed.csv')
factor_3_neu_std = process_std(factor_3_neu)
factor_3_neu_std.to_csv('answer/factor_3_processed.csv')
factor_4_neu_std = process_std(factor_4_neu)
factor_4_neu_std.to_csv('answer/factor_4_processed.csv')
```

## **å› å­æ£€éªŒ**
1. **RankICæ³•**ï¼šæ¯ä¸ªæœˆæœ«æˆªé¢æ—¥è®¡ç®—å› å­å€¼å’Œä¸‹ä¸ªè‡ªç„¶æœˆæ”¶ç›Šç‡çš„Spearmanç›¸å…³ç³»æ•°ï¼›
2. **åˆ†å±‚æµ‹è¯•æ³•**ï¼šæ¯ä¸ªæœˆæœ«æˆªé¢æ—¥å¯¹é`nan`å› å­å€¼è¿›è¡Œé™åºæ’åˆ—ï¼Œå‰20%è‚¡ç¥¨è§†ä½œç¬¬1å±‚ï¼Œ20%-40%è‚¡ç¥¨è§†ä½œç¬¬2å±‚â€¦â€¦ï¼Œä¸‹ä¸ªè‡ªç„¶æœˆæŒæœ‰è¯¥å±‚è‚¡ç¥¨ï¼Œç­‰æƒè®¡ç®—æ”¶ç›Šç‡ã€‚

### **åˆå§‹åŒ–**
```py
factor_1 = pd.read_csv('answer/factor_1_processed.csv')
factor_1 = factor_1.rename(columns={'Unnamed: 0': 'date'})

factor_2 = pd.read_csv('answer/factor_2_processed.csv')
factor_2 = factor_2.rename(columns={'Unnamed: 0': 'date'})

factor_3 = pd.read_csv('answer/factor_3_processed.csv')
factor_3 = factor_3.rename(columns={'Unnamed: 0': 'date'})

factor_4 = pd.read_csv('answer/factor_4_processed.csv')
factor_4 = factor_4.rename(columns={'Unnamed: 0': 'date'})

# æ£€æŸ¥å‘ç°close_adj_dayæˆªæ­¢åˆ°2024-11-30ï¼Œå› æ­¤æœ€åä¸€ä¸ªæœˆæ— æ³•è®¡ç®—å› å­æ”¶ç›Šï¼Œåªèƒ½èˆå¼ƒ
# mon = month # é¿å…ç ´åæ€§æ“ä½œï¼Œä¸ç„¶æ¯å¤šè¿è¡Œä¸€æ¬¡æœ¬æ®µç¨‹åºï¼Œmonthæœ«å°¾å°±ä¼šå¤šå‡ºä¸€è¡Œï¼Œå¯¼è‡´ç´¢å¼•ä¸åŒ¹é…
# mon[len(month)] = '2024-12-31'  # è¡¥å……æœ€åä¸€å¤©çš„æ—¥æœŸ
# month
```

### **RankICæ³•**
éå†æœˆæœ«æˆªé¢ï¼Œå¯¹æ¯ä¸ªæˆªé¢è®¡ç®—å½“å‰æˆªé¢å’Œä¸‹ä¸€ä¸ªæœˆæœ«æˆªé¢æ—¥é—´æ¯æ”¯è‚¡ç¥¨çš„æ”¶ç›Šç‡ï¼Œç„¶åå¯¹æ‰€æœ‰è‚¡ç¥¨çš„ç›¸å…³ç³»æ•°è¿›è¡ŒSpearmanç›¸å…³ç³»æ•°è®¡ç®—ã€‚

```py
def rankIC_test(factor):
    factor_test = pd.DataFrame(index=days,
                               columns=['rankIC', 'layer_1', 'layer_2', 'layer_3', 'layer_4', 'layer_5'])

    for i in range(149):
        date_1 = month[i]
        date_2 = month[i + 1]
        price_1 = close_adj_day[date_1]
        price_2 = close_adj_day[date_2]

        return_rate = (price_2 - price_1) / price_1

        factors = factor[factor['date'] == date_1]
        factors = factors.iloc[:, 1:].squeeze()
        factor_without_index = factors.reset_index(drop=True)

        valid_mask = factor_without_index.notna() & return_rate.notna()
        factor_valid = factor_without_index[valid_mask]
        return_rate_valid = return_rate[valid_mask]

        rankIC = spearmanr(factor_valid, return_rate_valid).correlation
        factor_test.loc[date_1, 'rankIC'] = rankIC

    return factor_test


factor_1_test = rankIC_test(factor_1)
factor_2_test = rankIC_test(factor_2)
factor_3_test = rankIC_test(factor_3)
factor_4_test = rankIC_test(factor_4)
```

### **åˆ†å±‚æµ‹è¯•æ³•**
éå†æœˆæœ«æˆªé¢ï¼Œå¯¹æ¯ä¸ªæˆªé¢è®¡ç®—å½“å‰æˆªé¢å’Œä¸‹ä¸€ä¸ªæœˆæœ«æˆªé¢æ—¥é—´æ¯æ”¯è‚¡ç¥¨çš„æ”¶ç›Šç‡ï¼Œç„¶åå¯¹æ‰€æœ‰è‚¡ç¥¨è¿›è¡Œåˆ†å±‚æµ‹è¯•ã€‚

```py
def layer_test(factor, factor_test):
    for i in range(len(month) - 1):
        date_1 = month[i]
        date_2 = month[i + 1]

        factors = factor[factor['date'] == date_1]
        factors = factors.iloc[:, 1:].squeeze()

        rank_factors = factors.rank(na_option='keep')
        num_stock = rank_factors.count()

        # æ¯ä¸€å±‚çš„æ•°é‡
        num_per_group = num_stock // 5
        close_1 = close_adj_day[date_1]
        close_2 = close_adj_day[date_2]
        return_rate = (close_2 - close_1) / close_1

        layer_return = []
        for j in range(5):
            start = j * num_per_group
            end = (j + 1) * num_per_group
            rank_factors = rank_factors.reset_index(drop=True)
            ind = rank_factors[(rank_factors >= start) & (rank_factors < end)]
            ind = ind.index
            layer_return.append(return_rate[ind].mean())
            factor_test.loc[date_1, 'layer_' + str(j + 1)] = layer_return[j]

    return factor_test


factor_1_test = layer_test(factor_1, factor_1_test)
factor_1_test.to_csv('answer/factor_1_test.csv')
factor_2_test = layer_test(factor_2, factor_2_test)
factor_2_test.to_csv('answer/factor_2_test.csv')
factor_3_test = layer_test(factor_3, factor_3_test)
factor_3_test.to_csv('answer/factor_3_test.csv')
factor_4_test = layer_test(factor_4, factor_4_test)
factor_4_test.to_csv('answer/factor_4_test.csv')
```

### **å›¾åƒç»˜åˆ¶**

```py
def illustrate_test(factor_test, i, x_tick_interval=29, date_format='%Y-%m'):
    # ç¡®ä¿ç´¢å¼•æ˜¯æ—¥æœŸç±»å‹
    if not pd.api.types.is_datetime64_any_dtype(factor_test.index):
        factor_test.index = pd.to_datetime(factor_test.index)

    # ç»˜åˆ¶ç´¯è®¡ RankIC
    rank_ic = factor_test['rankIC']
    cumulative_rank_ic = -1 * rank_ic.cumsum()
    plt.figure(figsize=(10, 6))
    plt.plot(cumulative_rank_ic.index, cumulative_rank_ic.values, label='Cumulative RankIC')
    plt.axhline(y=0, color='red', linestyle='--', linewidth=1, label='y=0')  # æ·»åŠ  y=0 æ°´å¹³çº¿
    x_ticks = cumulative_rank_ic.index[::x_tick_interval]
    plt.xticks(x_ticks, labels=[x.strftime(date_format) for x in x_ticks])
    plt.title(f'Factor_{i} Cumulative RankIC')
    plt.xlabel('Date')
    plt.ylabel('Cumulative RankIC')
    plt.grid(True, linestyle='--', alpha=0.7)
    plt.legend()
    plt.show()


    # ç»˜åˆ¶ç´¯è®¡æ”¶ç›Š
    cumulative_returns = factor_test.iloc[:, 1:].cumsum()
    cumulative_returns['Date'] = factor_test.index
    cumulative_returns.set_index('Date', inplace=True)

    plt.figure(figsize=(10, 6))
    cumulative_returns.plot(ax=plt.gca())
    plt.axhline(y=0, color='red', linestyle='--', linewidth=1, label='y=0')  # æ·»åŠ  y=0 æ°´å¹³çº¿
    x_ticks = cumulative_returns.index[::x_tick_interval]
    plt.xticks(x_ticks, labels=[x.strftime(date_format) for x in x_ticks])
    plt.title(f'Factor_{i} Cumulative Returns')
    plt.xlabel('Date')
    plt.ylabel('Cumulative Returns')
    plt.grid(True, linestyle='--', alpha=0.7)
    plt.legend(title='Factors')
    plt.show()


illustrate_test(factor_1_test, 1)
illustrate_test(factor_2_test, 2)
illustrate_test(factor_3_test, 3)
illustrate_test(factor_4_test, 4)
```

??? note "**å›¾åƒå‚è€ƒ**"
    RankICå›¾åº”è¯¥è¿‘ä¼¼æ˜¯ä¸€æ¡ä¸Šå‡çš„ç›´çº¿ï¼Œè€Œåˆ†å±‚æ”¶ç›Šå›¾å‘ˆå–‡å­å½¢å‘æ•£ï¼Œäº”æ¡æ›²çº¿æœ‰è¾ƒé«˜çš„åˆ†ç¦»åº¦ã€‚å¦‚æœä½ ç”»å‡ºçš„å›¾åƒå’Œå‚è€ƒå¾ˆä¸ä¸€æ ·ï¼Œå¤§æ¦‚ç‡æ˜¯ä»£ç å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®ä»”ç»†æ£€æŸ¥ã€‚

    <div style="text-align: center;">
        <img src="../image/IC.png" style="zoom:50%;" />
        <img src="../image/Return.png" style="zoom:50%;" />
    </div>